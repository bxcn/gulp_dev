/**  * kuaihuojian project - kuaihuojian project  */ "use strict";function getSMSList(t){var e=!0,a=0;t||(e=!1,a=$('input[name="searchCheckbox"]').val()),ajaxData.post({url:"/Template/getMsgTplList",data:{isList:e,customer_id:a},success:function(e){var a="",i=t?$("#showMassSMSList"):$("#showSMSList"),s=t?"'mass'":$('input[name="searchCheckbox"]').val(),l=$(".remainingTimes").eq(0),o=0;if(e.state){for(var d=0,n=e.data.length;d<n;d++){var r=e.data[d];o+=+r.todayTimes,a+='<li class="li">',a+='  <div class="name">',a+='    <span class="ml10">'+r.title+'</span><span class="ml15">（'+r.length+"字/"+Math.ceil(r.length/67)+'条）</span><em class="blue hand ml20"  onclick="alertMsg(this,'+r.id+')">预览</em>',a+="  </div>",a+='  <div class="btn">',!t&&r.todayTimes>1?a+='    <span class="button disabled">今日发送超限</span>':!t&&r.todayTimes<2?a+='    <button class="sendSMSBtn'+r.id+'" onclick="sendSMS(this,'+s+","+r.id+","+Math.ceil(r.length/67)+')">发送短信('+r.todayTimes+")</button>":t&&(a+='    <button onclick="sendSMS('+s+","+r.id+","+Math.ceil(r.length/67)+')">发送短信</button>'),a+="  </div>",a+="</li>"}i.html(a),l.text(5-o)}}})}function getEmailList(t){ajaxData.post({url:"/Template/getEmailTplList",success:function(e){var a="",i=t?$("#showMassEmailList"):$("#showEmailList"),s=t?"'mass'":$('input[name="searchCheckbox"]').val();if(e.state){for(var l=0,o=e.data.length;l<o;l++){var d=e.data[l];a+='<li class="li">',a+='  <div class="name">',a+='    <span class="ml10">'+d.title+'</span><span class="ml15">（'+Math.ceil(d.length/1024)+'KB）</span><em class="blue hand ml20"  onclick="alertMail(this,'+d.id+')">预览</em>',a+="  </div>",a+='  <div class="btn">',a+='    <button onclick="sendEmail('+s+","+d.id+')">发送邮件</button>',a+="  </div>",a+="</li>"}i.html(a)}}})}function getRecordList(){var t=$("#operationRecords"),e="";e+='<h3 class="f18">电话记录({telNumber}条)</h3>',e+='<table class="mt10">',e+="  <thead>",e+='    <tr class="title">',e+='      <td width="60%">操作时间</td>',e+='      <td width="20%">通话时长</td>',e+='      <td width="20%">通话录音</td>',e+="    </tr>",e+="  </thead>",e+="  {telList}",e+="</table>",e+='<h3 class="f18 mt20">短信记录({smsNumber}条)</h3>',e+='<table class="mt10">',e+="  <thead>",e+='    <tr class="title">',e+='      <td width="60%">操作时间</td>',e+='      <td width="20%">发送时间</td>',e+='      <td width="20%">查看内容</td>',e+="    </tr>",e+="  </thead>",e+="  {smsList}",e+="</table>",e+='<h3 class="f18 mt20">邮件记录({emailNumber}条)</h3>',e+='<table class="mt10">',e+="  <thead>",e+='    <tr class="title">',e+='      <td width="60%">操作时间</td>',e+='      <td width="20%">发送时间</td>',e+='      <td width="20%">查看内容</td>',e+="    </tr>",e+="  </thead>",e+="  {emailList}",e+="</table>";var a=$('input[name="searchCheckbox"]').val();a&&ajaxData.post({url:"/Record/getCustomerRecord",data:{id:a},success:function(a){if(a.state){for(var i="",s=0,l=0,o=a.data.callRecord.length;l<o;l++){var d=a.data.callRecord;i+="  <tr>",i+="    <td>时间："+d[l].starttime+"——"+d[l].endtime+"</td>",i+="    <td>"+d[l].calltime+"</td>",i+='    <td><em class="blue hand openAudio" data-logid="'+d[l].logid+'" data-voice-wav="'+d[l].wavrecord+'"  data-voice-mp3="'+d[l].mp3record+'" >通话录音</em></td>',i+="  </tr>"}0==o&&(i+="  <tr>",i+='    <td colspan="3">无记录</td>',i+="  </tr>"),s+=o,$(".callTimes").text(o),e=e.replace(/\{telNumber}/gi,o),e=e.replace(/\{telList}/gi,i),i="";for(var l=0,o=a.data.smsRecord.length;l<o;l++){var d=a.data.smsRecord;i+="  <tr>",i+='    <td><em class="mr10">'+d[l].title+"</em> "+d[l].length+"字/"+d[l].msg_count+"条</td>",i+="    <td>"+d[l].addtime+"</td>",i+='    <td><em class="blue hand" onclick="alertMsg(this,'+d[l].tpl_id+',1)">查看内容</em></td>',i+="  </tr>"}0==o&&(i+="  <tr>",i+='    <td colspan="3">无记录</td>',i+="  </tr>"),s+=o,$(".msgTimes").text(o),e=e.replace(/\{smsNumber}/gi,o),e=e.replace(/\{smsList}/gi,i),i="";for(var l=0,o=a.data.emailRecord.length;l<o;l++){var d=a.data.emailRecord;i+="  <tr>",i+='    <td><em class="mr10">'+d[l].title+"</em>("+d[l].length+"kb)</td>",i+="    <td>"+d[l].addtime+"</td>",i+='    <td><em class="blue hand" onclick="alertMail(this,'+d[l].tpl_id+',1)">查看内容</em></td>'}0==o&&(i+="  <tr>",i+='    <td colspan="3">无记录</td>',i+="  </tr>"),s+=o,$(".emailTimes").text(o),e=e.replace(/\{emailNumber}/gi,o),e=e.replace(/\{emailList}/gi,i),t.html(e),$(".operationNumber").text(s)}}})}function sendSMS(t,e,a){if("number"==typeof t)t=[t];else if("mass"==t){var i=$('input[name="searchCheckbox"]:checked');t=[],i.each(function(e,a){t.push($(a).val())})}if(t.length){massSendSMSDialog.dialog("open"),ajaxData.post({url:"/SellerSms/commitOrder",data:{receiver_ids:t,tpl_id:e},success:function(t){var e="";if(e+='<table class="mt10">',e+="    <tr>",e+='      <td width="20%">目标客户ID</td>',e+='      <td width="30%">目标客户</td>',e+='      <td width="30%">无法推送原因</td>',e+="    </tr>",t.state){var a=t.data;$("#massSendSMSDialog").find(".tsrs").text(a.cansend),$("#massSendSMSDialog").find(".dxts").text(a.msg_count),$("#massSendSMSDialog").find(".zqs").text(a.total_money),$("#massSendSMSDialog").find(".total_count").text(a.total_count),$("#massSendSMSDialog").find(".cannotsend").text(a.cannotsend);var i=t.data.list;if(i.length){for(var s=0,l=i.length;s<l;s++)e+="    <tr>",e+="      <td>"+i[s].rocket_id+"</td>",e+='      <td><em class="mr5">'+i[s].name+"</em>"+i[s].age+"</td>",e+="      <td>"+i[s].reason+"</td>",e+="    </tr>";e+="  </table>",$("#sendSMSState").html(e).parent().show()}else $("#sendSMSState").parent().hide();0==t.data.cansend&&(sureSendSMS=function(){alert("暂无有效推送人数")})}}});var s=!1;sureSendSMS=function(){s||(s=!0,window.setTimeout(function(){s=!1},3e3),ajaxData.post({url:"/SellerSms/sms_send",data:{receiver_ids:t,tpl_id:e},success:function(a){if(a.state){alert("发送成功"),massSendSMSDialog.dialog("close");var i=+$(".callTimes").eq(0).text(),s=+$(".emailTimes").eq(0).text(),l=+$(".msgTimes").eq(0).text();if($(".msgTimes").text(l+1),$(".operationNumber").text(i+l+s),1==t.length){var o=$(".sendSMSBtn"+e),d=+o.text().match(/(\d)+/g);o.text("发送短信("+(d+1)+")");var n=$(".remainingTimes").eq(0);n.text(n.text()-1);o.text().match(/(\d)*/gi);d+1>1&&o.toggleClass("disabled",!0).removeAttr("onclick").text("今日发送超限")}}else alert(a.msg||"发送失败")}}))}}else alert("请选择客户")}function sendEmail(t,e){if("number"==typeof t)t=[t];else if("mass"==t){var a=$('input[name="searchCheckbox"]:checked');t=[],a.each(function(e,a){t.push($(a).val())})}if(ajaxData.post({url:"/SellerEmailSend/isFundEnough",data:{receiver_ids:t,tpl_id:e},success:function(t){t.state?($('[data-trigger="chongzhi"]').hide(),$('[data-trigger="tishi"]').show()):($('[data-trigger="chongzhi"]').show(),$('[data-trigger="tishi"]').hide())}}),t.length){$("#massSendEmailDialog").find(".tsrs").text(t.length),$("#massSendEmailDialog").find(".zqs").text(parseFloat(.1*t.length).toFixed(1)),massSendEmailDialog.dialog("open");var i=!1;sureSendEmail=function(){i||(i=!0,window.setTimeout(function(){i=!1},3e3),ajaxData.post({url:"/SellerEmailSend/email_send",data:{receiver_ids:t,tpl_id:e},success:function(t){if(t.state){alert("发送成功"),massSendEmailDialog.dialog("close");var e=+$(".callTimes").eq(0).text(),a=+$(".emailTimes").eq(0).text(),i=+$(".msgTimes").eq(0).text();$(".emailTimes").text(a+1),$(".operationNumber").text(e+i+a)}else alert(t.msg||"发送失败")}}))}}}function favoriteAction(t,e){return t=$(t),t.hasClass("starstroke")?(modifyGroup.dialog("open"),favoriteGroupView(),void $("#FavoriteIds").val(e)):void ajaxData.post({url:"/Favorite/delete/",data:{ids:e},success:function(e){e.state?(t.removeClass("starfill"),t.addClass("starstroke"),alert(e.msg)):alert(e.msg)}})}$(".editPrice").click(function(){});var modifyGroup=$("#modifyGroup").dialog({width:450,height:300,title:"添加收藏"}),massSMSDialog=$("#massSMSDialog").dialog({width:760,height:480,title:"群发短信",buttons:[{text:"关闭",click:function(){$(this).dialog("close")}}]}),massEmailDialog=$("#massEmailDialog").dialog({width:760,height:480,title:"群发邮件",buttons:[{text:"关闭",click:function(){$(this).dialog("close")}}]}),callPrompt=$("#callPrompt").dialog({width:760,height:520,title:"提示信息",buttons:[{text:"知道了",click:function(){var t=$("input[name='noprompttel']:checked").val();$(this).dialog("close"),clockSubmit()||1==t&&ajaxData.post({url:"/ivrbase/closeNotify"})}}]}),delGroupDialog=$("#delGroupDialog").dialog({width:360,height:260,title:"确认删除分组",buttons:[{text:"取消",click:function(){$(this).dialog("close")}},{text:"确定",click:function(){var t=this,e=$("#delGroupId").val(),a=$('input[name="dtype"]:checked').val();ajaxData.post({url:"/FavoriteGroup/delete",data:{deltype:a,id:e},success:function(a){$(t).dialog("close"),a.state?($(".parent"+e).prev().addClass("last"),$(".parent"+e).remove(),$(".child"+e).remove(),favoriteGroupView(),window.location.reload()):alert(a.msg)}})}}]});$(".massSMS").click(function(){var t=$('input[name="searchCheckbox"]:checked');return t.size()?(massSMSDialog.dialog("open"),void getSMSList("mass")):void alert("请选择客户")}),$(".massEmail").click(function(){var t=$('input[name="searchCheckbox"]:checked');return t.size()?(massEmailDialog.dialog("open"),void getEmailList("mass")):void alert("请选择客户")}),$(document).on("click",".moveGroup",function(){var t=$('input[name="searchCheckbox"]:checked');if(!t.length)return void alert("请选择客户");var e=[];t.each(function(t,a){e.push($(a).val())}),$("#moveGroupIds").val(e),modifyGroup.dialog("open"),moveGroupView()});var favoriteGroupView=function(){return function(){$(function(){$("#groupView").treeNav({isLink:!1,isToolBar:!0,maxLevel:2,clickState:"favorite"})})}}(),moveGroupView=function(){return function(){$(function(){$("#groupView").treeNav({isLink:!1,isToolBar:!0,maxLevel:2,clickState:"move"})})}}();$(".favoriteBtn").click(function(){var t=$("#searchinfo").find('input[name="searchCheckbox"]:checked');if(!t.size())return void alert("请选择客户");var e=[];t.each(function(t,a){e.push($(a).val())}),$("#FavoriteIds").val(e),modifyGroup.dialog("open"),favoriteGroupView()});var currentOpenThat=null,sureSendSMS=function(){},sureSendEmail=function(){};$(".cancelFavorite").click(function(){var t=$('input[name="searchCheckbox"]:checked');return t.size()?(id=[],t.each(function(t,e){id.push($(e).val())}),void ajaxData.post({url:"/Favorite/deletes/",data:{ids:id.join(",")},success:function(t){t.state?promptDialog("取消成功",{OKText:"关闭",ok:function(){window.location.reload()}}):alert(t.msg)}})):void alert("请选择客户")});var telAudioDialog=$("#telAudioDialog").dialog({width:400,height:140,title:"通话录音",close:function(){audio.load(),audio.pause()}}),audio=null;$(document).on("click",".openAudio",function(){var t=$(this),e=($("#telAudioBar"),t.attr("data-voice-wav")),a=t.attr("data-voice-mp3"),i=t.attr("data-logid");if(window.AudioContext){if(!s&&!e)return void alert("暂无播放的通话记录");audio=document.querySelector("#audioBar");var s=document.querySelector("#audioWav");s.src=e;var l=document.querySelector("#audioMp3");l.src=a,audio.load(),audio.pause(),telAudioDialog.dialog("open")}else window.showModalDialog("/Record/callRecord?logid="+i,"name","dialogWidth=500px;dialogHeight=100px;status:no;alwaysRaised=true;z-look=true;")}),$(".audioPlay").click(function(){$(".audioPlay").hide(),$(".audioStop").show(),audio.play()}),$(".audioStop").click(function(){$(".audioPlay").show(),$(".audioStop").hide(),audio.pause()});var massSendSMSDialog=$("#massSendSMSDialog").dialog({width:700,height:500,title:"本次推送预计费用",buttons:[{text:"确认付款并立即发送",click:function(){sureSendSMS()}}]}),massSendEmailDialog=$("#massSendEmailDialog").dialog({width:700,height:400,title:"本次推送预计费用"});$('[data-trigger="sendEmailSave"]').click(function(){sureSendEmail()});